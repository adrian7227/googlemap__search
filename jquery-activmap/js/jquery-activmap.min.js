/* Activ'Map Plugin 2.1.1
 * Copyright (c) 2021 Pandao
 * Documentation : https://activmap.pandao.eu/doc
 */
!function($){"use strict";$.activmap={defaults:{places:[],lat:51.507351,lng:-.127758,zoom:10,cluster:!0,mapType:"roadmap",posPanel:"left",showPanel:!0,radius:0,unit:"km",country:null,autogeolocate:!1,allowMultiSelect:!0,icon:"images/icons/marker.png",center_icon:"images/icons/marker-center.png",styles:[{featureType:"administrative.country",elementType:"geometry",stylers:[{visibility:"simplified"},{hue:"#ff0000"}]}],request:"large",locationTypes:["geocode","establishment"],show_center:!0}},$.arrayIntersect=function(e,a){return $.grep(e,function(e){return-1<$.inArray(e,a)})},$.fn.extend({activmap:function(settings){var s=$.extend({},$.activmap.defaults,settings),init_latlng=new google.maps.LatLng(s.lat,s.lng),latlng=init_latlng,opendInfoWindow=null,markers=[],infoWindow=[],ids=[],markerCluster,centerMarker,bounds=new google.maps.LatLngBounds,num_places=0,old_results=0,mapTypeId=google.maps.MapTypeId.ROADMAP;"satellite"!=s.mapType&&"perspective"!=s.mapType||(mapTypeId=google.maps.MapTypeId.HYBRID);var map=new google.maps.Map(document.getElementById("activmap-canvas"),{zoom:s.zoom,center:latlng,mapTypeId:mapTypeId,styles:s.styles,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.BOTTOM_CENTER},zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},scaleControl:!0,streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},fullscreenControl:!1});bounds.extend(init_latlng);var init_latlngBounds=map.getBounds();"perspective"==s.mapType&&map.setTilt(45);var activmap_canvas=$("#activmap-container"),activmap_places=$("#activmap-places"),map_w=activmap_canvas.width(),cont_w=activmap_places.outerWidth();s.showPanel?("left"==s.posPanel&&(activmap_places.css({left:-cont_w,right:"auto"}),activmap_canvas.css({float:"right"})),"right"==s.posPanel&&(activmap_places.css({right:-cont_w,left:"auto"}),activmap_canvas.css({float:"left"}))):activmap_places.hide(),$('input[name="activmap_radius"]').length&&$('input[name="activmap_radius"]').prop("checked",!1).each(function(){s.radius==$(this).val()&&$(this).prop("checked",!0)});var _init=function(){var e,a,t;$.each(s.places,function(a,t){t.num_tags=0,t.id=a;var e=new google.maps.LatLng(t.lat,t.lng),n=(""!=t.icon&&null!=t.icon?t:s).icon,o=new google.maps.Marker({map:map,position:e,icon:n,title:t.title}),n='<div class="activmap-infowindow">';null!=t.img&&""!=t.img&&(n+='<div class="activmap-brand"><img src="'+t.img+'"></div>'),n+='<div class="activmap-details"><h4 class="activmap-title">'+t.title+"</h4>",null!=t.address&&""!=t.address&&(n+='<div class="activmap-address">'+t.address+"</div>"),null!=t.phone&&""!=t.phone&&(n+='<div class="activmap-phone">'+t.phone+"</div>"),null!=t.url&&""!=t.url&&(n+='<a href="'+t.url+'" target="_blank" class="activmap-url">'+t.url+"</a>"),null!=t.custom&&""!=t.custom&&(n+='<div class="activmap-custom">'+t.custom+"</div>"),n+='</div><div style="clear: both;"></div></div>',infoWindow[a]=new google.maps.InfoWindow({content:n,position:e}),google.maps.event.addListener(infoWindow[a],"closeclick",function(){$(".activmap-place").removeClass("active"),activmap_places.scrollTop()}),google.maps.event.addListener(o,"click",function(){null!=opendInfoWindow&&opendInfoWindow.close(),infoWindow[a].open(map,o),map.setCenter(o.getPosition());var e=_paddedBounds(20,280,50,50);map.fitBounds(e),opendInfoWindow=infoWindow[a],$(".activmap-place").removeClass("active"),$("#activmap-place_"+a).addClass("active"),activmap_places.scrollTop(activmap_places.scrollTop()+$("#activmap-place_"+a).position().top)}),o.setVisible(!1),t.marker=o,markers.push(o),t.title=t.title.replace(/<a\b[^>]*>(.*?)<\/a>/i,"$1"),t.html='<div class="activmap-place" id="activmap-place_'+a+'"><h3>'+t.title+"</h3><p>"+t.address+"</p></div>",$.each(t.tags,function(e,a){void 0===ids[a]&&(ids[a]=[]),ids[a].push(t.id)})}),s.cluster&&(markerCluster=new MarkerClusterer(map,markers,{maxZoom:12,gridSize:40})),s.show_center&&((centerMarker=new google.maps.Marker({map:map,position:latlng,icon:""!=s.center_icon&&null!=s.center_icon?s.center_icon:s.icon})).setVisible(!0),markers.push(centerMarker)),_order(),1==s.autogeolocate&&_geolocate(),$("#activmap-geolocate").length&&$("#activmap-geolocate").on("click",function(){_geolocate()}),$("#activmap-target").length&&$("#activmap-target").on("click",function(){latlng=init_latlng,_update_places_bounds(),_update_map()}),$("#activmap-location").length&&(e=null!==s.country?{types:s.locationTypes,componentRestrictions:{country:s.country}}:{types:s.locationTypes},a=document.getElementById("activmap-location"),t=new google.maps.places.Autocomplete(a,e),google.maps.event.addListener(t,"place_changed",function(){var e=t.getPlace();latlng=e.geometry.location,$(".activmap-place").length&&_order(),$('input[name="marker_type[]"], select[name="marker_type[]"]').each(function(){_update_places_tag($(this),!1)}),s.show_center&&_update_center_marker(),_update_map()})),$('input[name="activmap_radius"]').on("change",function(){s.radius=$(this).val(),$('input[name="marker_type[]"], select[name="marker_type[]"]').each(function(){_update_places_tag($(this),!1)}),_update_map()}),$('input[name="marker_type[]"], select[name="marker_type[]"]').on("change",function(){_update_places_tag($(this),!0),_update_map()}),$("#activmap-reset").on("click",function(){return $('input[name="marker_type[]"]').prop("checked",!1),$('select[name="marker_type[]"] > option').prop("selected",!1),$('input[name="marker_type[]"], select[name="marker_type[]"]').each(function(){_update_places_tag($(this),!1)}),latlng=init_latlng,s.show_center&&_update_center_marker(),_update_map(),!1}),$(document).on("click",".activmap-place",function(){var e=$(this).attr("id").replace("activmap-place_","");google.maps.event.trigger(markers[e],"click")}),$(window).on("resize",function(){setTimeout("_update_map()",300)}),$('input[name="marker_type[]"]:checked').add($('select[name="marker_type[]"]').prop("selected",!0)).each(function(){_update_places_tag($(this),!1)}),_update_map()},_sort_by_dist=function(e,a){return e.dist<a.dist?-1:e.dist>a.dist?1:0},_order=function(){$.each(s.places,function(e,a){a.dist=_get_distance(a.marker.position,latlng)}),s.places.sort(_sort_by_dist),$(".activmap-place").remove(),$.each(s.places,function(e,a){activmap_places.append(a.html),a.isVisible&&$("#activmap-place_"+a.id).show()})},_update_center_marker=function(){centerMarker.setPosition(latlng),_update_places_bounds()},_geolocate=function(){navigator.geolocation?(browserSupportFlag=!0,navigator.geolocation.getCurrentPosition(function(e){initialLocation=new google.maps.LatLng(e.coords.latitude,e.coords.longitude),latlng=initialLocation,$(".activmap-place").length&&_order(),$('input[name="marker_type[]"], select[name="marker_type[]"]').each(function(){_update_places_tag($(this),!1)}),s.show_center&&_update_center_marker(),_update_map()},function(){_handleNoGeolocation(browserSupportFlag)})):(browserSupportFlag=!1,_handleNoGeolocation(browserSupportFlag))},_handleNoGeolocation=function(e){initialLocation=(1==e?console.log("Geolocation service failed."):console.log("Your browser doesn't support geolocation."),latlng),map.setCenter(initialLocation)},_rad=function(e){return e*Math.PI/180},_paddedBounds=function(e,a,t,n){var o=map.getBounds().getSouthWest(),i=map.getBounds().getNorthEast(),s=map.getProjection().fromLatLngToPoint(i),c=map.getProjection().fromLatLngToPoint(o),p=Math.pow(2,map.getZoom()),o=map.getProjection().fromLatLngToPoint(o),a=new google.maps.Point((o.x-c.x)*p+n,(o.y-s.y)*p-a),a=new google.maps.Point(a.x/p+c.x,a.y/p+s.y),a=map.getProjection().fromPointToLatLng(a),i=map.getProjection().fromLatLngToPoint(i),e=new google.maps.Point((i.x-c.x)*p-t,(i.y-s.y)*p+e),s=new google.maps.Point(e.x/p+c.x,e.y/p+s.y),s=map.getProjection().fromPointToLatLng(s);return new google.maps.LatLngBounds(a,s)},_get_distance=function(e,a){var t="km"==s.unit?6378137:3963190,n=_rad(a.lat()-e.lat()),o=_rad(a.lng()-e.lng()),o=Math.sin(n/2)*Math.sin(n/2)+Math.cos(_rad(e.lat()))*Math.cos(_rad(a.lat()))*Math.sin(o/2)*Math.sin(o/2);return t*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))},_update_map=function(){map_w=$("#activmap-wrapper").width(),cont_w=activmap_places.outerWidth(),0<num_places?0==old_results?s.showPanel&&("left"==s.posPanel&&activmap_places.stop(!0,!0).animate({left:0},400),"right"==s.posPanel&&activmap_places.stop(!0,!0).animate({right:0},400),activmap_places.is(":visible")&&activmap_canvas.animate({width:map_w-cont_w},400)):s.showPanel&&activmap_places.is(":visible")&&1190<$(window).width()+17?activmap_canvas.width(map_w-cont_w):activmap_canvas.width(map_w):(null!=opendInfoWindow&&opendInfoWindow.close(),s.showPanel&&activmap_places.is(":visible")&&1190<$(window).width()+17?(activmap_canvas.animate({width:map_w},400),"left"==s.posPanel&&activmap_places.animate({left:-cont_w},400),"right"==s.posPanel&&activmap_places.animate({right:-cont_w},400)):activmap_canvas.width(map_w)),old_results=num_places,setTimeout(function(){google.maps.event.trigger(map,"resize");var e;google.maps.event.addListenerOnce(map,"idle",function(){16<map.getZoom()&&map.setZoom(16)});0<num_places?(map.fitBounds(bounds),e=_paddedBounds(10,150,50,50),map.fitBounds(e)):(map.setZoom(s.zoom),map.setCenter(latlng)),s.cluster&&markerCluster.repaint()},400)},_update_places_bounds=function(){bounds=new google.maps.LatLngBounds;var t=0;$.each(s.places,function(e,a){1==a.isVisible&&(bounds.extend(a.marker.getPosition()),t++)}),s.show_center&&bounds.extend(centerMarker.getPosition()),num_places=t},_update_places_tag=function(e,a){var t;s.allowMultiSelect||a&&($(".marker-selector").removeClass("active"),$('input[name="marker_type[]"]').not(e).prop("checked",!1),$('select[name="marker_type[]"]').not(e).find("option").prop("selected",!1)),1==("SELECT"==e.prop("tagName")?e.prop("selected"):e.prop("checked"))?e.parents(".marker-selector").addClass("active"):e.parents(".marker-selector").removeClass("active");var n,o=0,i=[];$('input[name="marker_type[]"]:checked').add($('select[name="marker_type[]"]').prop("selected",!0)).each(function(){""!=(t=$(this).val())&&(void 0===ids[t]&&(ids[t]=[]),0==o?i=$.merge([],ids[t]):("strict"==s.request&&(i=$.arrayIntersect(ids[t],i)),"large"==s.request&&(n=$.merge([],ids[t]),i=$.merge(n,i))),o++)}),null!=opendInfoWindow&&opendInfoWindow.close(),$.each(s.places,function(e,a){a.num_tags=0,(a.dist=0)<=$.inArray(a.id,i)?(a.dist=_get_distance(a.marker.position,latlng),0==s.radius||a.dist<=1e3*s.radius?(a.num_tags++,a.marker.setVisible(!0),a.isVisible=!0,$("#activmap-place_"+a.id).show()):(0<a.num_tags&&a.num_tags--,0==a.num_tags&&(a.marker.setVisible(!1),a.isVisible=!1,a.isVisible=!1,$("#activmap-place_"+a.id).hide()))):(0<a.num_tags&&a.num_tags--,0==a.num_tags&&(a.marker.setVisible(!1),a.isVisible=!1,$("#activmap-place_"+a.id).hide()))}),_update_places_bounds(),$("#activmap-results-num").html(num_places+" result(s)")};Array.isArray(s.places)?_init():$.ajax({url:s.places,dataType:"json",cache:!1,error:function(e,a,t){console.log(e),console.log(a),console.log(t)},success:function(data){var obj=eval(data);s.places=obj.places,_init()}})}})}(jQuery);
